---
import sendGrid from "@sendgrid/mail";
import { POST } from "./api/recaptcha";
import "../styles/index.css";
import Layout from "@layouts/Layout.astro";

sendGrid.setApiKey(import.meta.env.SENDGRID_API_KEY);
const errors = { name: "", email: "", subject: "", message: "" };
let formSubmittedSuccessfully = false;
//Source: https://docs.astro.build/en/recipes/build-forms/
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const name = data.get("name")?.toString() || "";
    const email = data.get("email")?.toString() || "";
    const subject = data.get("subject")?.toString() || "";
    const message = data.get("message")?.toString() || "";
    const token = data.get("g-recaptcha-response")?.toString() || "";
    const response = await POST({ token });

    if (!name) errors.name = "Please enter a username.";
    if (!email) errors.email = "Email is not valid.";
    if (!subject) errors.subject = "Please enter a subject.";
    if (message.length < 6)
      errors.message = "Message must be at least 6 characters.";
    const res = await response.json();

    if (response.status !== 200 || res.score < 0.5) {
      errors.message += " Please verify you are not a robot.";
    } else {
      formSubmittedSuccessfully = true;
      const msg = {
        to: "mischahaenen@gmail.com",
        from: "hello@mischahaenen.ch",
        replyTo: { email, name },
        subject: `Contact form submission from ${name}`,
        text: `${subject}\n\n${message}\n\nKind Regards\n${name}\n\n\nRecaptcha Score: ${res.score}`,
      };
      //await sendGrid.send(msg).catch(console.error);
    }
  } catch (error) {
    console.error(error);
  }
}
---

<Layout>
  <h1>Let's get in touch!</h1>
  <section
    class="success-message"
    aria-live="polite"
    class:list={formSubmittedSuccessfully ? "" : "hide-content"}
  >
    <h2>Success! ðŸŽ‰</h2>
    <p>
      Your message has been successfully sent. I appreciate you reaching out and
      I'll get back to you as soon as possible. In the meantime, feel free to
      browse my site. Thank you for getting in touch!
    </p>
    <img
      src="/assets/mail_sent.gif"
      alt="Illustration depicting a successfully sent email"
    />
  </section>

  <section
    aria-live="polite"
    class:list={formSubmittedSuccessfully ? "hide-content" : ""}
  >
    <!-- Source: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/form -->
    <form method="POST" id="contact-form" class="form">
      <label>
        Name:
        <input
          type="text"
          name="name"
          required
          aria-label="Your Name"
          placeholder="Your Name here..."
        />
        {errors.name && <p>{errors.name}</p>}
      </label>
      <label>
        Email:
        <input
          type="email"
          name="email"
          required
          aria-label="Your Email"
          placeholder="Your email here..."
        />
        {errors.email && <p>{errors.email}</p>}
      </label>
      <label class="two-column">
        Subject:
        <input
          type="text"
          name="subject"
          required
          aria-label="Subject of your message"
          placeholder="Write your subject here..."
        />
        {errors.subject && <p>{errors.subject}</p>}
      </label>
      <label class="two-column">
        Message:
        <textarea
          name="message"
          required
          aria-label="Your Message"
          placeholder="Write your message here..."></textarea>
        {errors.message && <p>{errors.message}</p>}
      </label>
      <button
        class="g-recaptcha"
        data-sitekey="6LdrjKYoAAAAAKTxD_31iDNVjFQzqRQAfkPd0v-j"
        data-callback="onSubmit"
        data-action="submit">Send Message</button
      >
    </form>
  </section>
  <script
    src="https://www.google.com/recaptcha/api.js?render=6LdrjKYoAAAAAKTxD_31iDNVjFQzqRQAfkPd0v-j"
    async
    defer></script>
  <script defer>
    //Source: https://docs.astro.build/en/guides/client-side-scripts/
    function onSubmit(token) {
      // @ts-ignore
      document.getElementById("contact-form").submit();
    }
  </script>
</Layout>
<style lang="scss">
  .hide-content.hide-content {
    display: none;
  }

  .success-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    text-align: center;
  }

  .form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    justify-items: center;
  }

  .form label {
    font-weight: bold;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
  }

  .two-column {
    grid-column: span 2;
  }

  .form input,
  .form textarea {
    padding: 1rem;
    background: var(--secondary-bg-color);
    border: 2px solid var(--grey-color);
    color: var(--primary-text-color);
    border-radius: 10px;
    font-family: var(--primary-font);
    font-size: 1rem;
    transition: border 0.3s ease;
    &:focus {
      border: 2px solid var(--primary-color);
      outline: none;
    }
  }

  .form textarea {
    resize: vertical;
    height: max(120px, 20vh);
  }

  .form p {
    color: red;
    margin: 5px 0;
    font-size: 0.9em;
  }

  .form button {
    margin-top: 1rem;
    padding: 1rem;
    background-color: var(--primary-color);
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
    grid-column: span 2;
    width: min(100%, 75ch);
  }

  .form button:hover {
    background-color: var(--primary-color-dark);
  }

  @media screen and (max-width: 768px) {
    .form {
      grid-template-columns: 1fr;
    }
    .two-column,
    .form button {
      grid-column: span 1;
    }
  }
</style>
